name: Android CI â€” Build APK

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest

    steps:
      # â”€â”€ 1. Checkout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout repository
        uses: actions/checkout@v4

      # â”€â”€ 2. JDK 17 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # â”€â”€ 3. Setup Gradle (auto-downloads wrapper jar) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      # â”€â”€ 4. Make gradlew executable â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Grant Gradlew permission
        run: chmod +x ./gradlew

      # â”€â”€ 5. Check if signing secrets exist â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Check signing secrets
        id: signing_check
        run: |
          if [ -n "${{ secrets.KEYSTORE_BASE64 }}" ] && \
             [ -n "${{ secrets.STORE_PASSWORD }}" ]  && \
             [ -n "${{ secrets.KEY_ALIAS }}" ]        && \
             [ -n "${{ secrets.KEY_PASSWORD }}" ]; then
            echo "has_secrets=true" >> $GITHUB_OUTPUT
            echo "âœ… All signing secrets present â€” building SIGNED APK"
          else
            echo "has_secrets=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  Signing secrets not set â€” building UNSIGNED APK"
            echo "Add these 4 secrets under: Settings â†’ Secrets â†’ Actions"
            echo "  KEYSTORE_BASE64 / STORE_PASSWORD / KEY_ALIAS / KEY_PASSWORD"
          fi

      # â”€â”€ 6. Decode keystore (only when secrets present) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Decode Keystore
        if: steps.signing_check.outputs.has_secrets == 'true'
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > app/keystore.jks
          echo "âœ… keystore.jks written"

      # â”€â”€ 7. Build APK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Build Release APK
        run: ./gradlew assembleRelease
        env:
          KEYSTORE_PATH:  ${{ steps.signing_check.outputs.has_secrets == 'true' && 'keystore.jks' || '' }}
          STORE_PASSWORD: ${{ secrets.STORE_PASSWORD }}
          KEY_ALIAS:      ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD:   ${{ secrets.KEY_PASSWORD }}

      # â”€â”€ 8. Find & rename APK (bulletproof â€” no glob) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Rename APK
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          SIGNED="${{ steps.signing_check.outputs.has_secrets }}"

          # Find the APK â€” works regardless of filename (signed or unsigned)
          APK_PATH=$(find app/build/outputs/apk/release/ -maxdepth 1 -name "*.apk" -type f | head -1)

          if [ -z "$APK_PATH" ]; then
            echo "âŒ ERROR: No APK found in app/build/outputs/apk/release/"
            ls -la app/build/outputs/apk/release/ || echo "(directory empty or missing)"
            exit 1
          fi

          echo "Found APK: $APK_PATH"

          LABEL=$([ "$SIGNED" = "true" ] && echo "signed" || echo "unsigned")
          DEST="app/build/outputs/apk/release/AudioSpy-v1.0-${SHORT_SHA}-${LABEL}.apk"
          mv "$APK_PATH" "$DEST"
          echo "âœ… Renamed to: $DEST"

      # â”€â”€ 9. Upload artifact â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: AudioSpy-APK
          path: app/build/outputs/apk/release/AudioSpy-*.apk
          retention-days: 30

      # â”€â”€ 10. GitHub Release (main branch, signed APK only) â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Create GitHub Release
        if: |
          github.ref == 'refs/heads/main' &&
          github.event_name == 'push' &&
          steps.signing_check.outputs.has_secrets == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v1.0-build${{ github.run_number }}
          name: "AudioSpy v1.0 â€” Build #${{ github.run_number }}"
          body: |
            ## ğŸ¤– Automated Signed Release
            | Field | Value |
            |---|---|
            | **Commit** | `${{ github.sha }}` |
            | **Branch** | `${{ github.ref_name }}` |
            | **Built by** | ${{ github.actor }} |
          files: app/build/outputs/apk/release/AudioSpy-*.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
